// Prisma schema for APSIC
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String      @id @default(cuid())
  wallet_address  String      @unique
  credits         Int         @default(0)
  priority_tier   String      @default("standard") // standard, premium, enterprise
  staked          Boolean     @default(false)
  created_at      DateTime    @default(now())
  updated_at      DateTime    @updatedAt

  incidents       Incident[]  @relation("Reporter")
  reviews         Review[]

  @@index([wallet_address])
}

model Incident {
  id                  String      @id @default(cuid())
  reporter_id         String
  reporter            User        @relation("Reporter", fields: [reporter_id], references: [id])

  text                String      @db.Text
  incident_type       String?     // harassment, accident, cyber, infrastructure, other
  media_urls          String[]    // Array of S3/R2 URLs

  severity_score      Float?
  severity_label      String?     // Low, Medium, High, Critical

  summary             String?     @db.Text
  recommended_actions String[]
  urgency             String?     // immediate, within_1_hour, within_24_hours, routine

  route               String?     // LogOnly, Review, Escalate, Immediate
  status              String      @default("processing") // processing, completed, failed

  extracted_fields    Json?       // Entities, location, parties, etc.

  opus_job_id         String?     @unique
  opus_status         String?

  created_at          DateTime    @default(now())
  updated_at          DateTime    @updatedAt

  audit_log           AuditLog?
  reviews             Review[]
  similar_incidents   SimilarIncident[]

  @@index([severity_score])
  @@index([incident_type])
  @@index([created_at])
  @@index([status])
}

model AuditLog {
  id              String      @id @default(cuid())
  incident_id     String      @unique
  incident        Incident    @relation(fields: [incident_id], references: [id], onDelete: Cascade)

  audit_json      Json        @db.JsonB  // Full audit trail
  pdf_url         String?     // Optional PDF report URL

  created_at      DateTime    @default(now())
}

model Review {
  id              String      @id @default(cuid())
  incident_id     String
  incident        Incident    @relation(fields: [incident_id], references: [id], onDelete: Cascade)

  reviewer_id     String?
  reviewer        User?       @relation(fields: [reviewer_id], references: [id])

  review_type     String      // agentic, human
  decision        String?     // approved, rejected, request_more_info
  notes           String?     @db.Text
  confidence      Float?

  created_at      DateTime    @default(now())

  @@index([incident_id])
}

model SimilarIncident {
  id                  String      @id @default(cuid())
  incident_id         String
  incident            Incident    @relation(fields: [incident_id], references: [id], onDelete: Cascade)

  similar_incident_id String
  similarity_score    Float

  @@index([incident_id])
}

model CreditLedger {
  id              String      @id @default(cuid())
  wallet_address  String
  amount          Int         // Positive = add, Negative = deduct
  transaction_type String     // purchase, incident_processing, refund
  incident_id     String?

  created_at      DateTime    @default(now())

  @@index([wallet_address])
  @@index([created_at])
}
